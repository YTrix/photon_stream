// compile using:
// g++ docopt/docopt.cpp example_viewer.cpp -o phs.view -std=gnu++11

#include <stdio.h>
#include <string.h>
#include <array>
#include "photon_stream.h"
#include "docopt/docopt.h"
#include <fstream>
#include <sstream>
#include <iostream>

namespace ps = photon_stream;

static const char USAGE[] =
R"(Show FACT photon-stream event overview. Reads in phs
files from stdin. 

    Usage:
      phs.view
      phs.view  (-h | --help)
      phs.view  --version

    Options:
      -h --help           Show this screen.
      --version           Show version.
      
)";

float px [] = {28.5,33.25,33.25,38.0,42.75,42.75,47.5,52.25,52.25,-0.0,4.75,4.75,9.5,14.25,14.25,19.0,23.75,23.75,71.25,66.5,66.5,61.75,57.0,57.0,52.25,47.5,47.5,42.75,38.0,38.0,33.25,28.5,28.5,23.75,19.0,19.0,114.0,109.25,109.25,104.5,99.75,99.75,95.0,90.25,90.25,133.0,128.25,123.5,118.75,123.5,118.75,114.0,109.25,104.5,104.5,99.75,95.0,90.25,95.0,90.25,85.5,80.75,76.0,85.5,80.75,76.0,76.0,71.25,66.5,61.75,61.75,57.0,128.25,123.5,123.5,118.75,114.0,114.0,109.25,104.5,104.5,152.0,147.25,142.5,137.75,147.25,142.5,137.75,133.0,128.25,99.75,95.0,95.0,90.25,85.5,85.5,80.75,76.0,76.0,71.25,66.5,66.5,61.75,57.0,57.0,52.25,47.5,47.5,85.5,80.75,80.75,76.0,71.25,71.25,66.5,61.75,61.75,57.0,52.25,52.25,47.5,42.75,42.75,38.0,33.25,33.25,28.5,23.75,23.75,19.0,14.25,14.25,9.5,4.75,4.75,42.75,38.0,38.0,33.25,28.5,28.5,23.75,19.0,19.0,175.75,175.75,171.0,166.25,161.5,161.5,156.75,152.0,147.25,171.0,166.25,161.5,156.75,156.75,152.0,147.25,142.5,133.0,142.5,137.75,137.75,133.0,128.25,128.25,123.5,118.75,118.75,114.0,109.25,109.25,104.5,99.75,99.75,95.0,90.25,90.25,85.5,80.75,80.75,76.0,71.25,71.25,66.5,61.75,61.75,57.0,52.25,52.25,47.5,42.75,42.75,38.0,33.25,33.25,28.5,23.75,23.75,19.0,14.25,14.25,9.5,4.75,4.75,14.25,9.5,9.5,4.75,-0.0,-0.0,-4.75,-9.5,-9.5,185.25,185.25,180.5,175.75,180.5,175.75,171.0,166.25,161.5,156.75,152.0,152.0,147.25,142.5,142.5,137.75,133.0,133.0,128.25,123.5,123.5,118.75,114.0,114.0,109.25,104.5,104.5,99.75,95.0,95.0,90.25,85.5,85.5,80.75,76.0,76.0,42.75,38.0,38.0,33.25,28.5,28.5,23.75,19.0,19.0,71.25,66.5,66.5,61.75,57.0,57.0,52.25,47.5,47.5,57.0,52.25,52.25,47.5,42.75,42.75,38.0,33.25,33.25,28.5,23.75,23.75,19.0,14.25,14.25,9.5,4.75,4.75,171.0,166.25,166.25,161.5,156.75,156.75,152.0,147.25,147.25,142.5,137.75,137.75,133.0,128.25,128.25,123.5,118.75,118.75,114.0,109.25,109.25,104.5,99.75,99.75,95.0,90.25,90.25,85.5,80.75,80.75,76.0,71.25,71.25,66.5,61.75,61.75,156.75,152.0,152.0,147.25,142.5,142.5,137.75,133.0,133.0,185.25,180.5,180.5,175.75,171.0,171.0,166.25,161.5,161.5,128.25,123.5,123.5,118.75,114.0,114.0,109.25,104.5,104.5,99.75,95.0,95.0,90.25,85.5,85.5,80.75,76.0,76.0,71.25,66.5,66.5,61.75,57.0,57.0,52.25,47.5,47.5,42.75,38.0,38.0,33.25,28.5,28.5,23.75,19.0,19.0,28.5,23.75,23.75,19.0,14.25,14.25,9.5,4.75,4.75,14.25,9.5,9.5,4.75,-0.0,-0.0,-4.75,-9.5,-9.5,85.5,80.75,80.75,76.0,71.25,71.25,66.5,61.75,61.75,57.0,52.25,52.25,47.5,42.75,42.75,38.0,33.25,33.25,42.75,38.0,38.0,33.25,28.5,28.5,23.75,19.0,19.0,14.25,9.5,9.5,4.75,-0.0,-0.0,-4.75,-9.5,-9.5,185.25,185.25,180.5,175.75,180.5,175.75,171.0,166.25,161.5,171.0,166.25,166.25,161.5,156.75,156.75,152.0,147.25,147.25,142.5,137.75,137.75,133.0,128.25,128.25,123.5,118.75,118.75,114.0,109.25,109.25,104.5,99.75,99.75,95.0,90.25,90.25,175.75,175.75,171.0,166.25,161.5,161.5,156.75,152.0,147.25,156.75,152.0,152.0,147.25,142.5,142.5,137.75,133.0,133.0,128.25,123.5,123.5,118.75,114.0,114.0,109.25,104.5,104.5,99.75,95.0,95.0,90.25,85.5,85.5,80.75,76.0,76.0,57.0,52.25,52.25,47.5,42.75,42.75,38.0,33.25,33.25,71.25,66.5,66.5,61.75,57.0,57.0,52.25,47.5,47.5,42.75,38.0,38.0,33.25,28.5,28.5,23.75,19.0,19.0,28.5,23.75,23.75,19.0,14.25,14.25,9.5,4.75,4.75,171.0,166.25,161.5,156.75,156.75,152.0,147.25,142.5,133.0,142.5,137.75,137.75,133.0,128.25,128.25,123.5,118.75,118.75,114.0,109.25,109.25,104.5,99.75,99.75,95.0,90.25,90.25,85.5,80.75,80.75,76.0,71.25,71.25,66.5,61.75,61.75,152.0,147.25,142.5,137.75,147.25,142.5,137.75,133.0,128.25,128.25,123.5,123.5,118.75,114.0,114.0,109.25,104.5,104.5,99.75,95.0,95.0,90.25,85.5,85.5,80.75,76.0,76.0,71.25,66.5,66.5,61.75,57.0,57.0,52.25,47.5,47.5,133.0,128.25,123.5,118.75,123.5,118.75,114.0,109.25,104.5,114.0,109.25,109.25,104.5,99.75,99.75,95.0,90.25,90.25,104.5,99.75,95.0,90.25,95.0,90.25,85.5,80.75,76.0,85.5,80.75,80.75,76.0,71.25,71.25,66.5,61.75,61.75,57.0,52.25,52.25,47.5,42.75,42.75,38.0,33.25,33.25,28.5,23.75,23.75,19.0,14.25,14.25,9.5,4.75,4.75,42.75,38.0,38.0,33.25,28.5,28.5,23.75,19.0,19.0,14.25,9.5,9.5,4.75,-0.0,-0.0,-4.75,-9.5,-9.5,85.5,80.75,76.0,76.0,71.25,66.5,61.75,61.75,57.0,71.25,66.5,66.5,61.75,57.0,57.0,52.25,47.5,47.5,28.5,33.25,33.25,38.0,42.75,42.75,47.5,52.25,52.25,-0.0,4.75,4.75,9.5,14.25,14.25,19.0,23.75,23.75,-57.0,-52.25,-52.25,-47.5,-42.75,-42.75,-38.0,-33.25,-33.25,-28.5,-23.75,-23.75,-19.0,-14.25,-14.25,-9.5,-4.75,-4.75,-42.75,-47.5,-47.5,-52.25,-57.0,-57.0,-61.75,-66.5,-66.5,-14.25,-19.0,-19.0,-23.75,-28.5,-28.5,-33.25,-38.0,-38.0,-85.5,-90.25,-90.25,-95.0,-99.75,-99.75,-104.5,-109.25,-109.25,-104.5,-114.0,-118.75,-123.5,-114.0,-118.75,-123.5,-128.25,-128.25,-71.25,-76.0,-80.75,-85.5,-90.25,-95.0,-99.75,-104.5,-109.25,-61.75,-66.5,-71.25,-76.0,-76.0,-80.75,-85.5,-90.25,-95.0,-99.75,-104.5,-104.5,-109.25,-114.0,-114.0,-118.75,-123.5,-123.5,-128.25,-133.0,-133.0,-137.75,-133.0,-137.75,-142.5,-142.5,-147.25,-71.25,-76.0,-76.0,-80.75,-85.5,-85.5,-90.25,-95.0,-95.0,-42.75,-47.5,-47.5,-52.25,-57.0,-57.0,-61.75,-66.5,-66.5,-57.0,-61.75,-61.75,-66.5,-71.25,-71.25,-76.0,-80.75,-80.75,-28.5,-33.25,-33.25,-38.0,-42.75,-42.75,-47.5,-52.25,-52.25,-14.25,-19.0,-19.0,-23.75,-28.5,-28.5,-33.25,-38.0,-38.0,-0.0,-4.75,-4.75,-9.5,-14.25,-14.25,-19.0,-23.75,-23.75,-147.25,-152.0,-156.75,-161.5,-166.25,-166.25,-171.0,-171.0,-175.75,-142.5,-147.25,-142.5,-156.75,-152.0,-152.0,-156.75,-147.25,-161.5,-114.0,-118.75,-118.75,-123.5,-128.25,-128.25,-133.0,-137.75,-137.75,-85.5,-90.25,-90.25,-95.0,-99.75,-99.75,-104.5,-109.25,-109.25,-57.0,-61.75,-61.75,-66.5,-71.25,-71.25,-76.0,-80.75,-80.75,-28.5,-33.25,-33.25,-38.0,-42.75,-42.75,-47.5,-52.25,-52.25,-0.0,-4.75,-4.75,-9.5,-14.25,-14.25,-19.0,-23.75,-23.75,14.25,9.5,9.5,4.75,-0.0,-0.0,-4.75,-9.5,-9.5,-156.75,-161.5,-161.5,-166.25,-171.0,-175.75,-175.75,-180.5,-185.25,-128.25,-133.0,-133.0,-137.75,-142.5,-142.5,-147.25,-152.0,-152.0,-99.75,-104.5,-104.5,-109.25,-114.0,-114.0,-118.75,-123.5,-123.5,-71.25,-76.0,-76.0,-80.75,-85.5,-85.5,-90.25,-95.0,-95.0,-42.75,-47.5,-47.5,-52.25,-57.0,-57.0,-61.75,-66.5,-66.5,-14.25,-19.0,-19.0,-23.75,-28.5,-28.5,-33.25,-38.0,-38.0,-28.5,-33.25,-33.25,-38.0,-42.75,-42.75,-47.5,-52.25,-52.25,-0.0,-4.75,-4.75,-9.5,-14.25,-14.25,-19.0,-23.75,-23.75,-142.5,-147.25,-147.25,-152.0,-156.75,-156.75,-161.5,-166.25,-166.25,-114.0,-118.75,-118.75,-123.5,-128.25,-128.25,-133.0,-137.75,-137.75,-85.5,-90.25,-90.25,-95.0,-99.75,-99.75,-104.5,-109.25,-109.25,-57.0,-61.75,-61.75,-66.5,-71.25,-71.25,-76.0,-80.75,-80.75,-156.75,-161.5,-161.5,-166.25,-171.0,-171.0,-175.75,-180.5,-185.25,-171.0,-171.0,-175.75,-180.5,-175.75,-180.5,-180.5,-185.25,-185.25,-128.25,-133.0,-133.0,-137.75,-142.5,-142.5,-147.25,-152.0,-152.0,-99.75,-104.5,-104.5,-109.25,-114.0,-114.0,-118.75,-123.5,-123.5,-71.25,-76.0,-76.0,-80.75,-85.5,-85.5,-90.25,-95.0,-95.0,-42.75,-47.5,-47.5,-52.25,-57.0,-57.0,-61.75,-66.5,-66.5,-14.25,-19.0,-19.0,-23.75,-28.5,-28.5,-33.25,-38.0,-38.0,-0.0,-4.75,-4.75,-9.5,-14.25,-14.25,-19.0,-23.75,-23.75,-57.0,-61.75,-61.75,-66.5,-71.25,-71.25,-76.0,-80.75,-80.75,-28.5,-33.25,-33.25,-38.0,-42.75,-42.75,-47.5,-52.25,-52.25,-14.25,-19.0,-19.0,-23.75,-28.5,-28.5,-33.25,-38.0,-38.0,14.25,9.5,9.5,4.75,-0.0,-0.0,-4.75,-9.5,-9.5,-156.75,-161.5,-161.5,-166.25,-171.0,-175.75,-175.75,-180.5,-185.25,-142.5,-147.25,-147.25,-152.0,-156.75,-156.75,-161.5,-166.25,-166.25,-114.0,-118.75,-118.75,-123.5,-128.25,-128.25,-133.0,-137.75,-137.75,-85.5,-90.25,-90.25,-95.0,-99.75,-99.75,-104.5,-109.25,-109.25,-147.25,-152.0,-156.75,-161.5,-166.25,-166.25,-171.0,-171.0,-175.75,-128.25,-133.0,-133.0,-137.75,-142.5,-142.5,-147.25,-152.0,-152.0,-99.75,-104.5,-104.5,-109.25,-114.0,-114.0,-118.75,-123.5,-123.5,-71.25,-76.0,-76.0,-80.75,-85.5,-85.5,-90.25,-95.0,-95.0,-28.5,-33.25,-33.25,-38.0,-42.75,-42.75,-47.5,-52.25,-52.25,-42.75,-47.5,-47.5,-52.25,-57.0,-57.0,-61.75,-66.5,-66.5,-14.25,-19.0,-19.0,-23.75,-28.5,-28.5,-33.25,-38.0,-38.0,-0.0,-4.75,-4.75,-9.5,-14.25,-14.25,-19.0,-23.75,-23.75,-142.5,-142.5,-147.25,-156.75,-147.25,-152.0,-152.0,-156.75,-161.5,-114.0,-118.75,-118.75,-123.5,-128.25,-128.25,-133.0,-137.75,-137.75,-85.5,-90.25,-90.25,-95.0,-99.75,-99.75,-104.5,-109.25,-109.25,-57.0,-61.75,-61.75,-66.5,-71.25,-71.25,-76.0,-80.75,-80.75,-128.25,-133.0,-133.0,-137.75,-133.0,-137.75,-142.5,-142.5,-147.25,-99.75,-104.5,-104.5,-109.25,-114.0,-114.0,-118.75,-123.5,-123.5,-71.25,-76.0,-76.0,-80.75,-85.5,-85.5,-90.25,-95.0,-95.0,-42.75,-47.5,-47.5,-52.25,-57.0,-57.0,-61.75,-66.5,-66.5,-104.5,-114.0,-118.75,-123.5,-114.0,-118.75,-123.5,-128.25,-128.25,-85.5,-90.25,-90.25,-95.0,-99.75,-99.75,-104.5,-109.25,-109.25,-71.25,-76.0,-80.75,-85.5,-90.25,-95.0,-99.75,-104.5,-109.25,-57.0,-61.75,-61.75,-66.5,-71.25,-71.25,-76.0,-80.75,-80.75,-28.5,-33.25,-33.25,-38.0,-42.75,-42.75,-47.5,-52.25,-52.25,-0.0,-4.75,-4.75,-9.5,-14.25,-14.25,-19.0,-23.75,-23.75,-14.25,-19.0,-19.0,-23.75,-28.5,-28.5,-33.25,-38.0,-38.0,14.25,9.5,9.5,4.75,-0.0,-0.0,-4.75,-9.5,-9.5,-61.75,-66.5,-71.25,-76.0,-76.0,-80.75,-85.5,-90.25,-95.0,-42.75,-47.5,-47.5,-52.25,-57.0,-57.0,-61.75,-66.5,-66.5,-57.0,-52.25,-52.25,-47.5,-42.75,-42.75,-38.0,-33.25,-33.25,-28.5,-23.75,-23.75,-19.0,-14.25,-14.25,-9.5,-4.75,-4.75};
float py [] = {172.805,180.975,164.54,172.805,180.975,164.54,172.805,180.975,164.54,172.805,180.975,164.54,172.805,180.975,164.54,172.805,180.975,164.54,148.105,139.84,156.275,148.105,139.84,156.275,148.105,139.84,156.275,148.105,139.84,156.275,148.105,139.84,156.275,148.105,139.84,156.275,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,131.67,123.805,115.14,139.84,131.67,139.84,148.105,139.84,156.275,148.105,156.275,164.54,139.84,148.105,139.84,148.105,139.84,156.275,164.54,156.275,172.805,164.54,172.805,164.54,180.975,172.805,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,106.97,98.705,106.97,98.705,115.14,123.805,115.14,106.97,115.14,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,49.4,65.835,57.57,65.835,57.57,74.005,65.835,74.005,65.835,74.005,82.27,90.535,82.27,98.705,90.535,82.27,90.535,90.535,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,16.435,32.87,24.7,16.435,41.135,32.87,41.135,49.4,41.135,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-32.87,-16.435,-24.7,-16.435,-41.135,-32.87,-41.135,-49.4,-41.135,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-65.835,-49.4,-57.57,-65.835,-74.005,-57.57,-65.835,-74.005,-65.835,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-90.535,-82.27,-98.705,-90.535,-82.27,-90.535,-90.535,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-106.97,-98.705,-106.97,-98.705,-115.14,-123.805,-115.14,-106.97,-115.14,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-123.805,-131.67,-123.805,-115.14,-139.84,-131.67,-139.84,-148.105,-139.84,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-156.275,-148.105,-156.275,-164.54,-139.84,-148.105,-139.84,-148.105,-139.84,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-156.275,-164.54,-172.805,-156.275,-164.54,-172.805,-180.975,-164.54,-172.805,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-172.805,-164.54,-180.975,-172.805,-164.54,-180.975,-172.805,-164.54,-180.975,-172.805,-164.54,-180.975,-172.805,-164.54,-180.975,-172.805,-164.54,-180.975,-172.805,-164.54,-180.975,-172.805,-164.54,-180.975,-172.805,-164.54,-180.975,-172.805,-164.54,-180.975,-172.805,-164.54,-180.975,-172.805,-164.54,-180.975,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-148.105,-156.275,-139.84,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-139.84,-139.84,-131.67,-139.84,-123.805,-115.14,-123.805,-131.67,-115.14,-148.105,-139.84,-148.105,-139.84,-148.105,-139.84,-148.105,-156.275,-148.105,-164.54,-172.805,-164.54,-172.805,-156.275,-164.54,-156.275,-164.54,-156.275,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-123.805,-115.14,-123.805,-106.97,-115.14,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-123.805,-131.67,-115.14,-65.835,-74.005,-65.835,-74.005,-82.27,-65.835,-74.005,-57.57,-65.835,-90.535,-82.27,-74.005,-82.27,-90.535,-106.97,-98.705,-98.705,-90.535,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-74.005,-82.27,-65.835,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-98.705,-106.97,-90.535,-49.4,-57.57,-41.135,-49.4,-41.135,-49.4,-32.87,-41.135,-32.87,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-49.4,-57.57,-41.135,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,-24.7,-32.87,-16.435,0.0,-8.265,8.265,0.0,8.265,24.7,16.435,24.7,16.435,-24.7,-8.265,-16.435,-24.7,0.0,-8.265,8.265,-16.435,0.0,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,0.0,-8.265,8.265,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,32.87,49.4,41.135,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,24.7,16.435,32.87,65.835,74.005,65.835,74.005,65.835,82.27,57.57,74.005,65.835,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,49.4,41.135,57.57,49.4,41.135,57.57,49.4,41.135,57.57,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,90.535,82.27,82.27,98.705,90.535,106.97,98.705,90.535,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,74.005,65.835,82.27,98.705,90.535,106.97,98.705,123.805,115.14,106.97,123.805,115.14,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,98.705,90.535,106.97,139.84,139.84,131.67,139.84,123.805,115.14,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,148.105,139.84,148.105,139.84,148.105,139.84,148.105,156.275,148.105,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,123.805,115.14,131.67,148.105,139.84,156.275,148.105,139.84,156.275,148.105,139.84,156.275,148.105,139.84,156.275,148.105,139.84,156.275,148.105,139.84,156.275,164.54,172.805,164.54,172.805,156.275,164.54,156.275,164.54,156.275,148.105,139.84,156.275,148.105,139.84,156.275,148.105,139.84,156.275,172.805,180.975,164.54,172.805,180.975,164.54,172.805,180.975,164.54,172.805,180.975,164.54,172.805,180.975,164.54,172.805,180.975,164.54};

uint8_t intensity_to_color_code(float i) {
    //std::cout << i << "\n";
    // ”<Esc>[48;5;ColorNumber
    if(i > 1.0)
        i = 1.0;
    if(i < 0.0)
        i = 0.0;
    float close = i*23.0;
    float contr = close + 232.0;
    uint8_t out = uint8_t(floor(contr));
    return out;
}

std::array<int, 9> nx =   { 1, 0,-1, 1, 0,-1, 1, 0,-1};
std::array<int, 9> ny =   { 1, 1, 1, 0, 0, 0,-1,-1,-1};
std::array<float, 9> we = {.3,.5,.3,.5, 1,.5,.3,.5,.3};

void print_image(ps::ObservationEvent &event) {
    std::array<uint64_t, ps::NUMBER_OF_PIXELS> img = ps::image_integral(
        event.photon_stream
    );

    std::array<std::array<float, 80>, 80> bg;
    for(int x=0; x<bg.size(); x++)
        for(int y=0; y<bg.at(x).size(); y++)
            bg.at(x).at(y) = 0;

    for(int chid=0; chid<img.size(); chid++) {
        float x = px[chid]/5.0 + 2*19.0;
        float y = py[chid]/5.0 + 2*19.0;

        int cx = int(round(x));
        int cy = int(round(y));

        for(uint64_t n=0; n<nx.size(); n++) {
            int ax = cx + nx.at(n);
            int ay = cy + ny.at(n);

            if(ax>=0 && ax<80 && ay>=0 && ay<80) {
                bg.at(ax).at(ay) += we.at(n)*float(img.at(chid));
            }
        }
        //std::cout << "bg.at(cx).at(cy) " << bg.at(cx).at(cy) << "\n";
    }

    float Mmax = 0.0;
    for(int x=0; x<bg.size(); x++) {
        for(int y=0; y<bg.at(x).size(); y++) {
            if(bg.at(x).at(y) > Mmax)
                Mmax = bg.at(x).at(y);
        }
    }
    //std::cout << "Mmax " << Mmax << "\n";

    std::array<std::array<float, 80>, 80> normal;
    for(int x=0; x<bg.size(); x++) {
        for(int y=0; y<bg.at(x).size(); y++) {
            normal.at(x).at(y) = float(bg.at(x).at(y))/Mmax;
            //std::cout << "normal.at(x).at(y) " << normal.at(x).at(y) << "\n";
        }
    }

    std::array<std::array<uint8_t, 80>, 80> color_code_img;
    for(int x=0; x<bg.size(); x++) {
        for(int y=0; y<bg.at(x).size(); y++) {
            color_code_img.at(x).at(y) = intensity_to_color_code(
                normal.at(x).at(y)
            );
            //std::cout << "color_code_img " << int(color_code_img.at(x).at(y)) << "\n";
        }
    }

    std::stringstream out;
    for(int x=0; x<bg.size(); x++) {
        for(int y=0; y<bg.at(x).size(); y++) {
            uint8_t color_code = color_code_img.at(x).at(y);
            std::string color = std::to_string(color_code);
            out << "\033[48;5;" << color << "m  \033[0m";
        }
        out << "\n";
    }

    // colorbar
    std::array<uint8_t, 65> bar;
    for(int i=0; i<bar.size(); i++) {
        float u = float(i)/bar.size();
        bar.at(i) = intensity_to_color_code(u);
    }

    out << "\n";
    out << "0 [";
    for(int i=0; i<bar.size(); i++) {
        uint8_t color_code = bar.at(i);
        std::string color = std::to_string(color_code);
        out << "\033[48;5;" << color << "m  \033[0m";
    }
    out << "] " << Mmax << " photons\n";
    std::cout << out.str();
}

void print_event_info_line(ps::ObservationEvent &event) {
    printf(
        "Night %05d, Run %03d, Event %5d, Trigger %6d, Az %3.2f, Zd %3.2f, UnixTime %10.6f, photons %6d\n",  
        event.id.night,
        event.id.run,
        event.id.event,
        event.info.trigger_type,
        event.pointing.az,
        event.pointing.zd,
        float(event.info.unix_time_s) + 1e-6*float(event.info.unix_time_us),
        event.photon_stream.number_of_photons()
    );
};

int main(int argc, char* argv[]) {

    std::map<std::string, docopt::value> args = docopt::docopt(
        USAGE,
        { argv + 1, argv + argc },
        true,        // show help if requested
        "mct 0.0"
    );  // version string

    while(true) {
        ps::ObservationEvent event = ps::read_ObservationEvent_from_file(std::cin);

        if(!event.descriptor.is_valid())
            break;

        print_event_info_line(event);
        print_image(event);
    }
    return 0;
};